<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
</head>
<body>
    <h1>Dashboard</h1>
    <div id="dashboard">Caricamento...</div>

    <script>
       async function refreshAccessToken() {
    try {
        const refreshResp = await fetch('http://localhost:8000/auth/refresh', {
            method: 'POST',
            credentials: 'include' // Indispensabile per inviare/ricevere cookie
        });

        if (!refreshResp.ok) {
            throw new Error('Sessione scaduta, effettuare login');
        }

        // Se il server ha risposto 200 OK, il browser ha già aggiornato 
        // il cookie "access_token" grazie all'header Set-Cookie.
        return true; 
    } catch (err) {
        console.error('Errore refresh:', err);
        return false;
    }
}

async function loadDashboard() {
    try {
        let response = await fetch('http://localhost:8013/home', {
            credentials: 'include'
        });

        // 1. Se riceviamo 401, proviamo il recupero tramite refresh
        if (response.status === 401) {
            console.warn("Access token scaduto, tentativo di refresh in corso...");
            
            // Chiamiamo la funzione che aggiorna il cookie
            const success = await refreshAccessToken();

            if (success) {
                // 2. RETRY: Se il refresh è riuscito, il cookie è ora aggiornato nel browser.
                // Ripetiamo la chiamata originale.

            
                response = await fetch('http://localhost:8013/home', {
                    credentials: 'include'
                });
            } else {
                // Se il refresh fallisce (es. anche il refresh token è scaduto)
                document.getElementById('dashboard').innerText = 'Sessione scaduta, effettua nuovamente il login.';
                // Opzionale: window.location.href = '/login';
                return;
            }
        }

        // 3. Gestione errori diversi dal 401 (es. 500, 404)
        if (!response.ok) {
            document.getElementById('dashboard').innerText = 'Errore nel caricamento dati: ' + response.status;
            return;
        }

        // 4. Successo: mostriamo i dati
        const data = await response.json();
        document.getElementById('dashboard').innerText = JSON.stringify(data, null, 2);

    } catch (err) {
        document.getElementById('dashboard').innerText = 'Errore di comunicazione con il server';
        console.error('Network Error:', err);
    }
}


       /* async function loadDashboard() {
            try {
                const response = await fetch('http://localhost:8013/home', {
                    credentials: 'include'  // serve per inviare i cookie
                });

                if (!response.ok) {
                    document.getElementById('dashboard').innerText = 'Errore: ' + response.status;
                    return;
                }

                const data = await response.json();
                // Mostri i dati nella pagina
                document.getElementById('dashboard').innerText = JSON.stringify(data, null, 2);
            } catch (err) {
                document.getElementById('dashboard').innerText = 'Errore di rete';
                console.error(err);
            }
        } */

        loadDashboard(); 
    </script>
</body>
</html>
